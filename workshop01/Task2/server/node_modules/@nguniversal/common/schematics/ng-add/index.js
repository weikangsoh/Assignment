var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/express-engine/schematics/ng-add/index", ["require", "exports", "@angular-devkit/core", "@angular-devkit/schematics", "@angular-devkit/schematics/tasks", "@schematics/angular/utility/ast-utils", "@schematics/angular/utility/change", "@schematics/angular/utility/dependencies", "@schematics/angular/utility/ng-ast-utils", "@schematics/angular/utility/workspace", "path", "typescript"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    /**
     * @license
     * Copyright Google LLC All Rights Reserved.
     *
     * Use of this source code is governed by an MIT-style license that can be
     * found in the LICENSE file at https://angular.io/license
     */
    const core_1 = require("@angular-devkit/core");
    const schematics_1 = require("@angular-devkit/schematics");
    const tasks_1 = require("@angular-devkit/schematics/tasks");
    const ast_utils_1 = require("@schematics/angular/utility/ast-utils");
    const change_1 = require("@schematics/angular/utility/change");
    const dependencies_1 = require("@schematics/angular/utility/dependencies");
    const ng_ast_utils_1 = require("@schematics/angular/utility/ng-ast-utils");
    const workspace_1 = require("@schematics/angular/utility/workspace");
    const path_1 = require("path");
    const ts = require("typescript");
    function default_1(options) {
        return (host, context) => __awaiter(this, void 0, void 0, function* () {
            const workspace = yield workspace_1.getWorkspace(host);
            const project = workspace.projects.get(options.project);
            if (project.extensions.projectType !== 'application') {
                throw new schematics_1.SchematicsException(`Universal requires a project type of "application".`);
            }
            const clientBuildTarget = project.targets.get('build');
            if (!clientBuildTarget) {
                throw new schematics_1.SchematicsException(`Project target "build" not found.`);
            }
            if (!options.skipInstall) {
                context.addTask(new tasks_1.NodePackageInstallTask());
            }
            return schematics_1.chain([
                augmentAppModuleRule(project, clientBuildTarget, options),
                options.ssr ? addSSRRule(project, clientBuildTarget) : schematics_1.noop(),
                options.prerender ? addPreRenderRule() : schematics_1.noop(),
                addScriptsRule(options),
                updateWorkspaceRule(options),
            ]);
        });
    }
    exports.default = default_1;
    function addPreRenderRule() {
        return (host) => __awaiter(this, void 0, void 0, function* () {
            dependencies_1.addPackageJsonDependency(host, {
                name: '@nguniversal/builders',
                type: dependencies_1.NodeDependencyType.Dev,
                version: '~12.0.0',
            });
        });
    }
    function addSSRRule(project, buildTarget) {
        return (host) => __awaiter(this, void 0, void 0, function* () {
            var _a;
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: 'express',
                version: '^4.15.2',
            });
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Dev,
                name: '@types/express',
                version: '^4.17.0',
            });
            const templateSource = schematics_1.apply(schematics_1.url('./files/src'), [
                schematics_1.applyTemplates({}),
                schematics_1.move((_a = project.sourceRoot) !== null && _a !== void 0 ? _a : '/src'),
            ]);
            const rootSource = schematics_1.apply(schematics_1.url('./files/root'), [
                schematics_1.applyTemplates({
                    tsConfigExtends: core_1.basename(core_1.normalize(buildTarget.options.tsConfig)),
                    relativePathToWorkspaceRoot: relativePathToWorkspaceRoot(project.root),
                }),
                schematics_1.move(project.root),
            ]);
            return schematics_1.chain([schematics_1.mergeWith(templateSource), schematics_1.mergeWith(rootSource)]);
        });
    }
    function addScriptsRule(options) {
        return (host) => __awaiter(this, void 0, void 0, function* () {
            const pkgPath = '/package.json';
            const buffer = host.read(pkgPath);
            if (!buffer) {
                throw new schematics_1.SchematicsException('Could not find package.json');
            }
            const pkg = JSON.parse(buffer.toString());
            if (options.prerender) {
                pkg.scripts = Object.assign(Object.assign({}, pkg.scripts), { 'prerender': `ng run ${options.project}:prerender` });
            }
            if (options.ssr) {
                pkg.scripts = Object.assign(Object.assign({}, pkg.scripts), { 'build:client-and-server': `ng build ${options.project} && ng run ${options.project}:server`, 'build:server': `ng run ${options.project}:server`, 'serve:ssr': `node dist/${options.project}/server/main.js` });
            }
            host.overwrite(pkgPath, JSON.stringify(pkg, null, 2));
        });
    }
    function updateWorkspaceRule(options) {
        return workspace_1.updateWorkspace((workspace) => {
            var _a, _b;
            const project = workspace.projects.get(options.project);
            if (options.ssr) {
                project.targets.add({
                    name: 'server',
                    builder: '@angular-devkit/build-angular:server',
                    options: {
                        outputPath: `dist/${options.project}/server`,
                        main: path_1.posix.join((_a = project.sourceRoot) !== null && _a !== void 0 ? _a : '', 'server.ts'),
                        tsConfig: path_1.posix.join(project.root, 'tsconfig.server.json'),
                        bundleDependencies: false,
                        optimization: false,
                    },
                });
                const buildTarget = project.targets.get('build');
                if ((_b = project.targets.get('build')) === null || _b === void 0 ? void 0 : _b.options) {
                    buildTarget.options.outputPath = `dist/${options.project}/browser`;
                }
            }
            if (options.prerender) {
                project.targets.add({
                    name: 'prerender',
                    builder: '@nguniversal/builders:static-generator',
                    defaultConfiguration: 'production',
                    options: {},
                    configurations: {
                        production: {
                            browserTarget: `${options.project}:build:production`,
                        },
                        development: {
                            browserTarget: `${options.project}:build:development`,
                        },
                    },
                });
            }
        });
    }
    function augmentAppModuleRule(project, buildTarget, options) {
        return (host) => {
            const bootstrapModuleRelativePath = ng_ast_utils_1.findBootstrapModulePath(host, buildTarget.options.main);
            const bootstrapModulePath = core_1.normalize(`/${project.sourceRoot}/${bootstrapModuleRelativePath}.ts`);
            // Add BrowserModule.withServerTransition()
            const browserModuleImport = findBrowserModuleImport(host, bootstrapModulePath);
            const transitionCall = `.withServerTransition({ appId: '${options.appId}' })`;
            const position = browserModuleImport.pos + browserModuleImport.getFullText().length;
            const transitionCallChange = new change_1.InsertChange(bootstrapModulePath, position, transitionCall);
            const transitionCallRecorder = host.beginUpdate(bootstrapModulePath);
            transitionCallRecorder.insertLeft(transitionCallChange.pos, transitionCallChange.toAdd);
            host.commitUpdate(transitionCallRecorder);
            // Add @nguniversal/common/clover
            let changes = ast_utils_1.addImportToModule(getSourceFile(host, bootstrapModulePath), bootstrapModulePath, 'RendererModule.forRoot()', '@nguniversal/common/clover');
            let recorder = host.beginUpdate(bootstrapModulePath);
            change_1.applyToUpdateRecorder(recorder, changes);
            host.commitUpdate(recorder);
            changes = ast_utils_1.addImportToModule(getSourceFile(host, bootstrapModulePath), bootstrapModulePath, 'TransferHttpCacheModule', '@nguniversal/common/clover');
            recorder = host.beginUpdate(bootstrapModulePath);
            change_1.applyToUpdateRecorder(recorder, changes);
            host.commitUpdate(recorder);
        };
    }
    function relativePathToWorkspaceRoot(projectRoot) {
        const normalizedPath = core_1.split(core_1.normalize(projectRoot || ''));
        if (normalizedPath.length === 0 || !normalizedPath[0]) {
            return '.';
        }
        else {
            return normalizedPath.map(() => '..').join('/');
        }
    }
    function findBrowserModuleImport(host, modulePath) {
        const source = getSourceFile(host, modulePath);
        const decoratorMetadata = ast_utils_1.getDecoratorMetadata(source, 'NgModule', '@angular/core')[0];
        const browserModuleNode = ast_utils_1.findNode(decoratorMetadata, ts.SyntaxKind.Identifier, 'BrowserModule');
        if (!browserModuleNode) {
            throw new schematics_1.SchematicsException(`Cannot find BrowserModule import in ${modulePath}`);
        }
        return browserModuleNode;
    }
    function getSourceFile(host, path) {
        const buffer = host.read(path);
        if (!buffer) {
            throw new schematics_1.SchematicsException(`Could not find ${path}.`);
        }
        const content = buffer.toString();
        const source = ts.createSourceFile(path, content, ts.ScriptTarget.Latest, true);
        return source;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9tb2R1bGVzL2NvbW1vbi9zY2hlbWF0aWNzL25nLWFkZC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUFBOzs7Ozs7T0FNRztJQUNILCtDQUFrRTtJQUVsRSwyREFXb0M7SUFDcEMsNERBQTBFO0lBQzFFLHFFQUkrQztJQUMvQywrREFBeUY7SUFDekYsMkVBR2tEO0lBQ2xELDJFQUFtRjtJQUNuRixxRUFBc0Y7SUFDdEYsK0JBQTZCO0lBQzdCLGlDQUFpQztJQUlqQyxtQkFBeUIsT0FBcUI7UUFDNUMsT0FBTyxDQUFPLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUM3QixNQUFNLFNBQVMsR0FBRyxNQUFNLHdCQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXhELElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEtBQUssYUFBYSxFQUFFO2dCQUNwRCxNQUFNLElBQUksZ0NBQW1CLENBQUMscURBQXFELENBQUMsQ0FBQzthQUN0RjtZQUVELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDdkQsSUFBSSxDQUFDLGlCQUFpQixFQUFFO2dCQUN0QixNQUFNLElBQUksZ0NBQW1CLENBQUMsbUNBQW1DLENBQUMsQ0FBQzthQUNwRTtZQUVELElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFO2dCQUN4QixPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksOEJBQXNCLEVBQUUsQ0FBQyxDQUFDO2FBQy9DO1lBRUQsT0FBTyxrQkFBSyxDQUFDO2dCQUNYLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxpQkFBaUIs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R0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDbEMsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFaEYsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHsgYmFzZW5hbWUsIG5vcm1hbGl6ZSwgc3BsaXQgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgeyBQcm9qZWN0RGVmaW5pdGlvbiwgVGFyZ2V0RGVmaW5pdGlvbiB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlL3NyYy93b3Jrc3BhY2UnO1xuaW1wb3J0IHtcbiAgUnVsZSxcbiAgU2NoZW1hdGljc0V4Y2VwdGlvbixcbiAgVHJlZSxcbiAgYXBwbHksXG4gIGFwcGx5VGVtcGxhdGVzLFxuICBjaGFpbixcbiAgbWVyZ2VXaXRoLFxuICBtb3ZlLFxuICBub29wLFxuICB1cmwsXG59IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzJztcbmltcG9ydCB7IE5vZGVQYWNrYWdlSW5zdGFsbFRhc2sgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XG5pbXBvcnQge1xuICBhZGRJbXBvcnRUb01vZHVsZSxcbiAgZmluZE5vZGUsXG4gIGdldERlY29yYXRvck1ldGFkYXRhLFxufSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvYXN0LXV0aWxzJztcbmltcG9ydCB7IEluc2VydENoYW5nZSwgYXBwbHlUb1VwZGF0ZVJlY29yZGVyIH0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2NoYW5nZSc7XG5pbXBvcnQge1xuICBOb2RlRGVwZW5kZW5jeVR5cGUsXG4gIGFkZFBhY2thZ2VKc29uRGVwZW5kZW5jeSxcbn0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2RlcGVuZGVuY2llcyc7XG5pbXBvcnQgeyBmaW5kQm9vdHN0cmFwTW9kdWxlUGF0aCB9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9uZy1hc3QtdXRpbHMnO1xuaW1wb3J0IHsgZ2V0V29ya3NwYWNlLCB1cGRhdGVXb3Jrc3BhY2UgfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvd29ya3NwYWNlJztcbmltcG9ydCB7IHBvc2l4IH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyB0cyBmcm9tICd0eXBlc2NyaXB0JztcblxuaW1wb3J0IHsgU2NoZW1hIGFzIE5nQWRkT3B0aW9ucyB9IGZyb20gJy4vc2NoZW1hJztcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKG9wdGlvbnM6IE5nQWRkT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gYXN5bmMgKGhvc3QsIGNvbnRleHQpID0+IHtcbiAgICBjb25zdCB3b3Jrc3BhY2UgPSBhd2FpdCBnZXRXb3Jrc3BhY2UoaG9zdCk7XG4gICAgY29uc3QgcHJvamVjdCA9IHdvcmtzcGFjZS5wcm9qZWN0cy5nZXQob3B0aW9ucy5wcm9qZWN0KTtcblxuICAgIGlmIChwcm9qZWN0LmV4dGVuc2lvbnMucHJvamVjdFR5cGUgIT09ICdhcHBsaWNhdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKGBVbml2ZXJzYWwgcmVxdWlyZXMgYSBwcm9qZWN0IHR5cGUgb2YgXCJhcHBsaWNhdGlvblwiLmApO1xuICAgIH1cblxuICAgIGNvbnN0IGNsaWVudEJ1aWxkVGFyZ2V0ID0gcHJvamVjdC50YXJnZXRzLmdldCgnYnVpbGQnKTtcbiAgICBpZiAoIWNsaWVudEJ1aWxkVGFyZ2V0KSB7XG4gICAgICB0aHJvdyBuZXcgU2NoZW1hdGljc0V4Y2VwdGlvbihgUHJvamVjdCB0YXJnZXQgXCJidWlsZFwiIG5vdCBmb3VuZC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIW9wdGlvbnMuc2tpcEluc3RhbGwpIHtcbiAgICAgIGNvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzaygpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2hhaW4oW1xuICAgICAgYXVnbWVudEFwcE1vZHVsZVJ1bGUocHJvamVjdCwgY2xpZW50QnVpbGRUYXJnZXQsIG9wdGlvbnMpLFxuICAgICAgb3B0aW9ucy5zc3IgPyBhZGRTU1JSdWxlKHByb2plY3QsIGNsaWVudEJ1aWxkVGFyZ2V0KSA6IG5vb3AoKSxcbiAgICAgIG9wdGlvbnMucHJlcmVuZGVyID8gYWRkUHJlUmVuZGVyUnVsZSgpIDogbm9vcCgpLFxuICAgICAgYWRkU2NyaXB0c1J1bGUob3B0aW9ucyksXG4gICAgICB1cGRhdGVXb3Jrc3BhY2VSdWxlKG9wdGlvbnMpLFxuICAgIF0pO1xuICB9O1xufVxuXG5mdW5jdGlvbiBhZGRQcmVSZW5kZXJSdWxlKCk6IFJ1bGUge1xuICByZXR1cm4gYXN5bmMgKGhvc3QpID0+IHtcbiAgICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3koaG9zdCwge1xuICAgICAgbmFtZTogJ0BuZ3VuaXZlcnNhbC9idWlsZGVycycsXG4gICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGV2LFxuICAgICAgdmVyc2lvbjogJ34wLjAuMC1QTEFDRUhPTERFUicsXG4gICAgfSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGFkZFNTUlJ1bGUocHJvamVjdDogUHJvamVjdERlZmluaXRpb24sIGJ1aWxkVGFyZ2V0OiBUYXJnZXREZWZpbml0aW9uKTogUnVsZSB7XG4gIHJldHVybiBhc3luYyAoaG9zdCkgPT4ge1xuICAgIGFkZFBhY2thZ2VKc29uRGVwZW5kZW5jeShob3N0LCB7XG4gICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGVmYXVsdCxcbiAgICAgIG5hbWU6ICdleHByZXNzJyxcbiAgICAgIHZlcnNpb246ICdFWFBSRVNTX1ZFUlNJT04nLFxuICAgIH0pO1xuXG4gICAgYWRkUGFja2FnZUpzb25EZXBlbmRlbmN5KGhvc3QsIHtcbiAgICAgIHR5cGU6IE5vZGVEZXBlbmRlbmN5VHlwZS5EZXYsXG4gICAgICBuYW1lOiAnQHR5cGVzL2V4cHJlc3MnLFxuICAgICAgdmVyc2lvbjogJ0VYUFJFU1NfVFlQRVNfVkVSU0lPTicsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0ZW1wbGF0ZVNvdXJjZSA9IGFwcGx5KHVybCgnLi9maWxlcy9zcmMnKSwgW1xuICAgICAgYXBwbHlUZW1wbGF0ZXMoe30pLFxuICAgICAgbW92ZShwcm9qZWN0LnNvdXJjZVJvb3QgPz8gJy9zcmMnKSxcbiAgICBdKTtcbiAgICBjb25zdCByb290U291cmNlID0gYXBwbHkodXJsKCcuL2ZpbGVzL3Jvb3QnKSwgW1xuICAgICAgYXBwbHlUZW1wbGF0ZXMoe1xuICAgICAgICB0c0NvbmZpZ0V4dGVuZHM6IGJhc2VuYW1lKG5vcm1hbGl6ZSgoYnVpbGRUYXJnZXQub3B0aW9ucyBhcyBhbnkpLnRzQ29uZmlnKSksXG4gICAgICAgIHJlbGF0aXZlUGF0aFRvV29ya3NwYWNlUm9vdDogcmVsYXRpdmVQYXRoVG9Xb3Jrc3BhY2VSb290KHByb2plY3Qucm9vdCksXG4gICAgICB9KSxcbiAgICAgIG1vdmUocHJvamVjdC5yb290KSxcbiAgICBdKTtcblxuICAgIHJldHVybiBjaGFpbihbbWVyZ2VXaXRoKHRlbXBsYXRlU291cmNlKSwgbWVyZ2VXaXRoKHJvb3RTb3VyY2UpXSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGFkZFNjcmlwdHNSdWxlKG9wdGlvbnM6IE5nQWRkT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gYXN5bmMgKGhvc3QpID0+IHtcbiAgICBjb25zdCBwa2dQYXRoID0gJy9wYWNrYWdlLmpzb24nO1xuICAgIGNvbnN0IGJ1ZmZlciA9IGhvc3QucmVhZChwa2dQYXRoKTtcbiAgICBpZiAoIWJ1ZmZlcikge1xuICAgICAgdGhyb3cgbmV3IFNjaGVtYXRpY3NFeGNlcHRpb24oJ0NvdWxkIG5vdCBmaW5kIHBhY2thZ2UuanNvbicpO1xuICAgIH1cblxuICAgIGNvbnN0IHBrZyA9IEpTT04ucGFyc2UoYnVmZmVyLnRvU3RyaW5nKCkpIGFzIGFueTtcbiAgICBpZiAob3B0aW9ucy5wcmVyZW5kZXIpIHtcbiAgICAgIHBrZy5zY3JpcHRzID0ge1xuICAgICAgICAuLi5wa2cuc2NyaXB0cyxcbiAgICAgICAgJ3ByZXJlbmRlcic6IGBuZyBydW4gJHtvcHRpb25zLnByb2plY3R9OnByZXJlbmRlcmAsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnNzcikge1xuICAgICAgcGtnLnNjcmlwdHMgPSB7XG4gICAgICAgIC4uLnBrZy5zY3JpcHRzLFxuICAgICAgICAnYnVpbGQ6Y2xpZW50LWFuZC1zZXJ2ZXInOiBgbmcgYnVpbGQgJHtvcHRpb25zLnByb2plY3R9ICYmIG5nIHJ1biAke29wdGlvbnMucHJvamVjdH06c2VydmVyYCxcbiAgICAgICAgJ2J1aWxkOnNlcnZlcic6IGBuZyBydW4gJHtvcHRpb25zLnByb2plY3R9OnNlcnZlcmAsXG4gICAgICAgICdzZXJ2ZTpzc3InOiBgbm9kZSBkaXN0LyR7b3B0aW9ucy5wcm9qZWN0fS9zZXJ2ZXIvbWFpbi5qc2AsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGhvc3Qub3ZlcndyaXRlKHBrZ1BhdGgsIEpTT04uc3RyaW5naWZ5KHBrZywgbnVsbCwgMikpO1xuICB9O1xufVxuXG5mdW5jdGlvbiB1cGRhdGVXb3Jrc3BhY2VSdWxlKG9wdGlvbnM6IE5nQWRkT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gdXBkYXRlV29ya3NwYWNlKCh3b3Jrc3BhY2UpID0+IHtcbiAgICBjb25zdCBwcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzLmdldChvcHRpb25zLnByb2plY3QpO1xuICAgIGlmIChvcHRpb25zLnNzcikge1xuICAgICAgcHJvamVjdC50YXJnZXRzLmFkZCh7XG4gICAgICAgIG5hbWU6ICdzZXJ2ZXInLFxuICAgICAgICBidWlsZGVyOiAnQGFuZ3VsYXItZGV2a2l0L2J1aWxkLWFuZ3VsYXI6c2VydmVyJyxcbiAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgIG91dHB1dFBhdGg6IGBkaXN0LyR7b3B0aW9ucy5wcm9qZWN0fS9zZXJ2ZXJgLFxuICAgICAgICAgIG1haW46IHBvc2l4LmpvaW4ocHJvamVjdC5zb3VyY2VSb290ID8/ICcnLCAnc2VydmVyLnRzJyksXG4gICAgICAgICAgdHNDb25maWc6IHBvc2l4LmpvaW4ocHJvamVjdC5yb290LCAndHNjb25maWcuc2VydmVyLmpzb24nKSxcbiAgICAgICAgICBidW5kbGVEZXBlbmRlbmNpZXM6IGZhbHNlLFxuICAgICAgICAgIG9wdGltaXphdGlvbjogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgYnVpbGRUYXJnZXQgPSBwcm9qZWN0LnRhcmdldHMuZ2V0KCdidWlsZCcpO1xuICAgICAgaWYgKHByb2plY3QudGFyZ2V0cy5nZXQoJ2J1aWxkJyk/Lm9wdGlvbnMpIHtcbiAgICAgICAgYnVpbGRUYXJnZXQub3B0aW9ucy5vdXRwdXRQYXRoID0gYGRpc3QvJHtvcHRpb25zLnByb2plY3R9L2Jyb3dzZXJgO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnByZXJlbmRlcikge1xuICAgICAgcHJvamVjdC50YXJnZXRzLmFkZCh7XG4gICAgICAgIG5hbWU6ICdwcmVyZW5kZXInLFxuICAgICAgICBidWlsZGVyOiAnQG5ndW5pdmVyc2FsL2J1aWxkZXJzOnN0YXRpYy1nZW5lcmF0b3InLFxuICAgICAgICBkZWZhdWx0Q29uZmlndXJhdGlvbjogJ3Byb2R1Y3Rpb24nLFxuICAgICAgICBvcHRpb25zOiB7fSxcbiAgICAgICAgY29uZmlndXJhdGlvbnM6IHtcbiAgICAgICAgICBwcm9kdWN0aW9uOiB7XG4gICAgICAgICAgICBicm93c2VyVGFyZ2V0OiBgJHtvcHRpb25zLnByb2plY3R9OmJ1aWxkOnByb2R1Y3Rpb25gLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZGV2ZWxvcG1lbnQ6IHtcbiAgICAgICAgICAgIGJyb3dzZXJUYXJnZXQ6IGAke29wdGlvbnMucHJvamVjdH06YnVpbGQ6ZGV2ZWxvcG1lbnRgLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBhdWdtZW50QXBwTW9kdWxlUnVsZShcbiAgcHJvamVjdDogUHJvamVjdERlZmluaXRpb24sXG4gIGJ1aWxkVGFyZ2V0OiBUYXJnZXREZWZpbml0aW9uLFxuICBvcHRpb25zOiBOZ0FkZE9wdGlvbnMsXG4pOiBSdWxlIHtcbiAgcmV0dXJuIChob3N0OiBUcmVlKSA9PiB7XG4gICAgY29uc3QgYm9vdHN0cmFwTW9kdWxlUmVsYXRpdmVQYXRoID0gZmluZEJvb3RzdHJhcE1vZHVsZVBhdGgoXG4gICAgICBob3N0LFxuICAgICAgYnVpbGRUYXJnZXQub3B0aW9ucy5tYWluIGFzIHN0cmluZyxcbiAgICApO1xuICAgIGNvbnN0IGJvb3RzdHJhcE1vZHVsZVBhdGggPSBub3JtYWxpemUoXG4gICAgICBgLyR7cHJvamVjdC5zb3VyY2VSb290fS8ke2Jvb3RzdHJhcE1vZHVsZVJlbGF0aXZlUGF0aH0udHNgLFxuICAgICk7XG5cbiAgICAvLyBBZGQgQnJvd3Nlck1vZHVsZS53aXRoU2VydmVyVHJhbnNpdGlvbigpXG4gICAgY29uc3QgYnJvd3Nlck1vZHVsZUltcG9ydCA9IGZpbmRCcm93c2VyTW9kdWxlSW1wb3J0KGhvc3QsIGJvb3RzdHJhcE1vZHVsZVBhdGgpO1xuICAgIGNvbnN0IHRyYW5zaXRpb25DYWxsID0gYC53aXRoU2VydmVyVHJhbnNpdGlvbih7IGFwcElkOiAnJHtvcHRpb25zLmFwcElkfScgfSlgO1xuICAgIGNvbnN0IHBvc2l0aW9uID0gYnJvd3Nlck1vZHVsZUltcG9ydC5wb3MgKyBicm93c2VyTW9kdWxlSW1wb3J0LmdldEZ1bGxUZXh0KCkubGVuZ3RoO1xuICAgIGNvbnN0IHRyYW5zaXRpb25DYWxsQ2hhbmdlID0gbmV3IEluc2VydENoYW5nZShib290c3RyYXBNb2R1bGVQYXRoLCBwb3NpdGlvbiwgdHJhbnNpdGlvbkNhbGwpO1xuXG4gICAgY29uc3QgdHJhbnNpdGlvbkNhbGxSZWNvcmRlciA9IGhvc3QuYmVnaW5VcGRhdGUoYm9vdHN0cmFwTW9kdWxlUGF0aCk7XG4gICAgdHJhbnNpdGlvbkNhbGxSZWNvcmRlci5pbnNlcnRMZWZ0KHRyYW5zaXRpb25DYWxsQ2hhbmdlLnBvcywgdHJhbnNpdGlvbkNhbGxDaGFuZ2UudG9BZGQpO1xuICAgIGhvc3QuY29tbWl0VXBkYXRlKHRyYW5zaXRpb25DYWxsUmVjb3JkZXIpO1xuXG4gICAgLy8gQWRkIEBuZ3VuaXZlcnNhbC9jb21tb24vY2xvdmVyXG4gICAgbGV0IGNoYW5nZXMgPSBhZGRJbXBvcnRUb01vZHVsZShcbiAgICAgIGdldFNvdXJjZUZpbGUoaG9zdCwgYm9vdHN0cmFwTW9kdWxlUGF0aCksXG4gICAgICBib290c3RyYXBNb2R1bGVQYXRoLFxuICAgICAgJ1JlbmRlcmVyTW9kdWxlLmZvclJvb3QoKScsXG4gICAgICAnQG5ndW5pdmVyc2FsL2NvbW1vbi9jbG92ZXInLFxuICAgICk7XG4gICAgbGV0IHJlY29yZGVyID0gaG9zdC5iZWdpblVwZGF0ZShib290c3RyYXBNb2R1bGVQYXRoKTtcbiAgICBhcHBseVRvVXBkYXRlUmVjb3JkZXIocmVjb3JkZXIsIGNoYW5nZXMpO1xuICAgIGhvc3QuY29tbWl0VXBkYXRlKHJlY29yZGVyKTtcblxuICAgIGNoYW5nZXMgPSBhZGRJbXBvcnRUb01vZHVsZShcbiAgICAgIGdldFNvdXJjZUZpbGUoaG9zdCwgYm9vdHN0cmFwTW9kdWxlUGF0aCksXG4gICAgICBib290c3RyYXBNb2R1bGVQYXRoLFxuICAgICAgJ1RyYW5zZmVySHR0cENhY2hlTW9kdWxlJyxcbiAgICAgICdAbmd1bml2ZXJzYWwvY29tbW9uL2Nsb3ZlcicsXG4gICAgKTtcbiAgICByZWNvcmRlciA9IGhvc3QuYmVnaW5VcGRhdGUoYm9vdHN0cmFwTW9kdWxlUGF0aCk7XG4gICAgYXBwbHlUb1VwZGF0ZVJlY29yZGVyKHJlY29yZGVyLCBjaGFuZ2VzKTtcbiAgICBob3N0LmNvbW1pdFVwZGF0ZShyZWNvcmRlcik7XG4gIH07XG59XG5cbmZ1bmN0aW9uIHJlbGF0aXZlUGF0aFRvV29ya3NwYWNlUm9vdChwcm9qZWN0Um9vdDogc3RyaW5nIHwgdW5kZWZpbmVkKTogc3RyaW5nIHtcbiAgY29uc3Qgbm9ybWFsaXplZFBhdGggPSBzcGxpdChub3JtYWxpemUocHJvamVjdFJvb3QgfHwgJycpKTtcblxuICBpZiAobm9ybWFsaXplZFBhdGgubGVuZ3RoID09PSAwIHx8ICFub3JtYWxpemVkUGF0aFswXSkge1xuICAgIHJldHVybiAnLic7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5vcm1hbGl6ZWRQYXRoLm1hcCgoKSA9PiAnLi4nKS5qb2luKCcvJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZmluZEJyb3dzZXJNb2R1bGVJbXBvcnQoaG9zdDogVHJlZSwgbW9kdWxlUGF0aDogc3RyaW5nKTogdHMuTm9kZSB7XG4gIGNvbnN0IHNvdXJjZSA9IGdldFNvdXJjZUZpbGUoaG9zdCwgbW9kdWxlUGF0aCk7XG4gIGNvbnN0IGRlY29yYXRvck1ldGFkYXRhID0gZ2V0RGVjb3JhdG9yTWV0YWRhdGEoc291cmNlLCAnTmdNb2R1bGUnLCAnQGFuZ3VsYXIvY29yZScpWzBdO1xuICBjb25zdCBicm93c2VyTW9kdWxlTm9kZSA9IGZpbmROb2RlKGRlY29yYXRvck1ldGFkYXRhLCB0cy5TeW50YXhLaW5kLklkZW50aWZpZXIsICdCcm93c2VyTW9kdWxlJyk7XG5cbiAgaWYgKCFicm93c2VyTW9kdWxlTm9kZSkge1xuICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKGBDYW5ub3QgZmluZCBCcm93c2VyTW9kdWxlIGltcG9ydCBpbiAke21vZHVsZVBhdGh9YCk7XG4gIH1cblxuICByZXR1cm4gYnJvd3Nlck1vZHVsZU5vZGU7XG59XG5cbmZ1bmN0aW9uIGdldFNvdXJjZUZpbGUoaG9zdDogVHJlZSwgcGF0aDogc3RyaW5nKTogdHMuU291cmNlRmlsZSB7XG4gIGNvbnN0IGJ1ZmZlciA9IGhvc3QucmVhZChwYXRoKTtcbiAgaWYgKCFidWZmZXIpIHtcbiAgICB0aHJvdyBuZXcgU2NoZW1hdGljc0V4Y2VwdGlvbihgQ291bGQgbm90IGZpbmQgJHtwYXRofS5gKTtcbiAgfVxuICBjb25zdCBjb250ZW50ID0gYnVmZmVyLnRvU3RyaW5nKCk7XG4gIGNvbnN0IHNvdXJjZSA9IHRzLmNyZWF0ZVNvdXJjZUZpbGUocGF0aCwgY29udGVudCwgdHMuU2NyaXB0VGFyZ2V0LkxhdGVzdCwgdHJ1ZSk7XG5cbiAgcmV0dXJuIHNvdXJjZTtcbn1cbiJdfQ==