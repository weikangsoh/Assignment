/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/common/clover/server/src/server-engine", ["require", "exports", "tslib", "fs", "jsdom", "path", "url", "@nguniversal/common/clover/server/src/custom-resource-loader", "@nguniversal/common/clover/server/src/inline-css-processor"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.Engine = void 0;
    const tslib_1 = require("tslib");
    const fs = tslib_1.__importStar(require("fs"));
    const jsdom_1 = require("jsdom");
    const path = tslib_1.__importStar(require("path"));
    const url_1 = require("url");
    const custom_resource_loader_1 = require("@nguniversal/common/clover/server/src/custom-resource-loader");
    const inline_css_processor_1 = require("@nguniversal/common/clover/server/src/inline-css-processor");
    class Engine {
        constructor() {
            this.fileExistsCache = new Map();
            this.htmlFileCache = new Map();
            this.resourceLoaderCache = new Map();
            this.inlineCriticalCssProcessor = new inline_css_processor_1.InlineCriticalCssProcessor({ minify: true }, this.resourceLoaderCache);
        }
        render(options) {
            var _a, _b, _c, _d, _e;
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const { pathname, origin } = new url_1.URL(options.url);
                const prerenderedSnapshot = yield this.getPrerenderedSnapshot(options.publicPath, pathname);
                if (prerenderedSnapshot) {
                    return prerenderedSnapshot;
                }
                let htmlContent = yield this.getHtmlTemplate(options.publicPath, pathname, options.htmlFilename);
                const inlineCriticalCss = options.inlineCriticalCss !== false;
                const customResourceLoader = new custom_resource_loader_1.CustomResourceLoader(origin, options.publicPath, this.resourceLoaderCache);
                let dom;
                if (inlineCriticalCss) {
                    // Workaround for https://github.com/GoogleChromeLabs/critters/issues/64
                    htmlContent = htmlContent.replace(/ media=\"print\" onload=\"this\.media='all'"><noscript><link .+?><\/noscript>/g, '>');
                }
                try {
                    dom = new jsdom_1.JSDOM(htmlContent, {
                        runScripts: 'dangerously',
                        resources: customResourceLoader,
                        url: options.url,
                        referrer: (_a = options.headers) === null || _a === void 0 ? void 0 : _a.referrer,
                        userAgent: (_b = options.headers) === null || _b === void 0 ? void 0 : _b['user-agent'],
                        beforeParse: (window) => {
                            window.ngRenderMode = true;
                        },
                    });
                    const doc = dom.window.document;
                    // 60s timeout.
                    const stablizationTimeout = setTimeout(() => {
                        throw new Error('Angular application failed to stablize after in time.');
                    }, 60000);
                    // tslint:disable-next-line: no-shadowed-variable
                    const ngRenderMode = yield new Promise((resolve) => {
                        const interval = setInterval(() => {
                            const ngDOMMode = dom === null || dom === void 0 ? void 0 : dom.window.ngRenderMode;
                            if (ngDOMMode && typeof ngDOMMode === 'object') {
                                // Poll until ngDOMMode is an object.
                                clearTimeout(stablizationTimeout);
                                clearInterval(interval);
                                resolve(ngDOMMode);
                            }
                        }, 30);
                    });
                    yield ngRenderMode.getWhenStable();
                    (_c = doc.querySelector('[ng-version]')) === null || _c === void 0 ? void 0 : _c.setAttribute('ng-clover', '');
                    // Add Angular state
                    const state = ngRenderMode.getSerializedState();
                    if (state) {
                        const script = doc.createElement('script');
                        script.id = `${ngRenderMode.appId}-state`;
                        script.setAttribute('type', 'application/json');
                        script.textContent = state;
                        doc.body.appendChild(script);
                    }
                    const content = dom.serialize();
                    if (!options.inlineCriticalCss) {
                        return content;
                    }
                    const baseHref = (_e = (_d = doc.querySelector('base[href]')) === null || _d === void 0 ? void 0 : _d.getAttribute('href')) !== null && _e !== void 0 ? _e : '';
                    const { content: contentWithInlineCSS, warnings, errors, } = yield this.inlineCriticalCssProcessor.process(content, {
                        outputPath: path.join(options.publicPath, baseHref),
                    });
                    // tslint:disable-next-line: no-console
                    warnings === null || warnings === void 0 ? void 0 : warnings.forEach((m) => console.warn(m));
                    // tslint:disable-next-line: no-console
                    errors === null || errors === void 0 ? void 0 : errors.forEach((m) => console.error(m));
                    return contentWithInlineCSS;
                }
                finally {
                    dom === null || dom === void 0 ? void 0 : dom.window.close();
                }
            });
        }
        getPrerenderedSnapshot(publicPath, pathname) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                // Remove leading forward slash.
                const pagePath = path.resolve(publicPath, pathname.substring(1), 'index.html');
                const content = yield this.readHTMLFile(pagePath);
                return (content === null || content === void 0 ? void 0 : content.includes('ng-version='))
                    ? content // Page is pre-rendered
                    : undefined;
            });
        }
        getHtmlTemplate(publicPath, pathname, htmlFilename = 'index.html') {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const files = [path.join(publicPath, htmlFilename)];
                const potentialLocalePath = pathname.split('/', 2)[1]; // potential base href
                if (potentialLocalePath) {
                    files.push(path.join(publicPath, potentialLocalePath, htmlFilename));
                }
                for (const file of files) {
                    const content = yield this.readHTMLFile(file);
                    if (content) {
                        return content;
                    }
                }
                throw new Error(`Cannot file HTML file. Looked in: ${files.join(', ')}`);
            });
        }
        fileExists(filePath) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                const fileExists = this.fileExistsCache.get(filePath);
                if (fileExists === undefined) {
                    try {
                        yield fs.promises.access(filePath, fs.constants.F_OK);
                        this.fileExistsCache.set(filePath, true);
                        return true;
                    }
                    catch (_a) {
                        this.fileExistsCache.set(filePath, false);
                        return false;
                    }
                }
                return fileExists;
            });
        }
        readHTMLFile(filePath) {
            return tslib_1.__awaiter(this, void 0, void 0, function* () {
                if (this.htmlFileCache.has(filePath)) {
                    return this.htmlFileCache.get(filePath);
                }
                if (yield this.fileExists(filePath)) {
                    const content = yield fs.promises.readFile(filePath, 'utf-8');
                    this.htmlFileCache.set(filePath, content);
                    return content;
                }
                return undefined;
            });
        }
    }
    exports.Engine = Engine;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLWVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL21vZHVsZXMvY29tbW9uL2Nsb3Zlci9zZXJ2ZXIvc3JjL3NlcnZlci1lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HOzs7Ozs7Ozs7Ozs7OztJQU1ILCtDQUF5QjtJQUN6QixpQ0FBOEI7SUFDOUIsbURBQTZCO0lBQzdCLDZCQUEwQjtJQUMxQix5R0FBZ0U7SUFDaEUscUdBQW9FO0lBVXBFLE1BQWEsTUFBTTtRQUFuQjtZQUNtQixvQkFBZSxHQUFHLElBQUksR0FBRyxFQUFtQixDQUFDO1lBQzdDLGtCQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7WUFDMUMsd0JBQW1CLEdBQUcsSUFBSSxHQUFHLEVBQWtCLENBQUM7WUFDaEQsK0JBQTBCLEdBQUcsSUFBSSxpREFBMEIsQ0FDMUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQ2hCLElBQUksQ0FBQyxtQkFBbUIsQ0FDekIsQ0FBQztRQTBLSixDQUFDO1FBeEtPLE1BQU0sQ0FBQyxPQUFzQjs7O2dCQUNqQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksU0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDbEQsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2dCQUU1RixJQUFJLG1CQUFtQixFQUFFO29CQUN2QixPQUFPLG1CQUFtQixDQUFDO2lCQUM1QjtnQkFFRCxJQUFJLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQzFDLE9BQU8sQ0FBQyxVQUFVLEVBQ2xCLFFBQVEsRUFDUixPQUFPLENBQUMsWUFBWSxDQUNyQixDQUFDO2dCQUNGLE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixLQUFLLEtBQUssQ0FBQztnQkFFOUQsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLDZDQUFvQixDQUNuRCxNQUFNLEVBQ04sT0FBTyxDQUFDLFVBQVUsRUFDbEIsSUFBSSxDQUFDLG1CQUFtQixDQUN6QixDQUFDO2dCQUVGLElBQUksR0FBc0IsQ0FBQztnQkFFM0IsSUFBSSxpQkFBaUIsRUFBRTtvQkFDckIsd0VBQXdFO29CQUN4RSxXQUFXLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FDL0IsZ0ZBQWdGLEVBQ2hGLEdBQUcsQ0FDSixDQUFDO2lCQUNIO2dCQUVELElBQUk7b0JBQ0YsR0FBRyxHQUFHLElBQUksYUFBSyxDQUFDLFdBQVcsRUFBRTt3QkFDM0IsVUFBVSxFQUFFLGFBQWE7d0JBQ3pCLFNBQVMsRUFBRSxvQkFBb0I7d0JBQy9CLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRzt3QkFDaEIsUUFBUSxFQUFFLE1BQUEsT0FBTyxDQUFDLE9BQU8sMENBQUUsUUFBOEI7d0JBQ3pELFNBQVMsRUFBRSxNQUFBLE9BQU8sQ0FBQyxPQUFPLDBDQUFHLFlBQVksQ0FBdUI7d0JBQ2hFLFdBQVcsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFOzRCQUN0QixNQUFNLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQzt3QkFDN0IsQ0FBQztxQkFDRixDQUFDLENBQUM7b0JBRUgsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7b0JBRWhDLGVBQWU7b0JBQ2YsTUFBTSxtQkFBbUIsR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO3dCQUMxQyxNQUFNLElBQUksS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7b0JBQzNFLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFFVixpREFBaUQ7b0JBQ2pELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxPQUFPLENBQWtCLENBQUMsT0FBTyxFQUFFLEVBQUU7d0JBQ2xFLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7NEJBQ2hDLE1BQU0sU0FBUyxHQUFHLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxNQUFNLENBQUMsWUFBNEIsQ0FBQzs0QkFDM0QsSUFBSSxTQUFTLElBQUksT0FBTyxTQUFTLEtBQUssUUFBUSxFQUFFO2dDQUM5QyxxQ0FBcUM7Z0NBQ3JDLFlBQVksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO2dDQUNsQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7Z0NBQ3hCLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQzs2QkFDcEI7d0JBQ0gsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUNULENBQUMsQ0FBQyxDQUFDO29CQUVILE1BQU0sWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDO29CQUNuQyxNQUFBLEdBQUcsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLDBDQUFFLFlBQVksQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7b0JBRWpFLG9CQUFvQjtvQkFDcEIsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLGtCQUFrQixFQUFFLENBQUM7b0JBQ2hELElBQUksS0FBSyxFQUFFO3dCQUNULE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7d0JBQzNDLE1BQU0sQ0FBQyxFQUFFLEdBQUcsR0FBRyxZQUFZLENBQUMsS0FBSyxRQUFRLENBQUM7d0JBQzFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLGtCQUFrQixDQUFDLENBQUM7d0JBQ2hELE1BQU0sQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO3dCQUMzQixHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztxQkFDOUI7b0JBRUQsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO29CQUNoQyxJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFO3dCQUM5QixPQUFPLE9BQU8sQ0FBQztxQkFDaEI7b0JBRUQsTUFBTSxRQUFRLEdBQUcsTUFBQSxNQUFBLEdBQUcsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLDBDQUFFLFlBQVksQ0FBQyxNQUFNLENBQUMsbUNBQUksRUFBRSxDQUFDO29CQUM3RSxNQUFNLEVBQ0osT0FBTyxFQUFFLG9CQUFvQixFQUM3QixRQUFRLEVBQ1IsTUFBTSxHQUNQLEdBQUcsTUFBTSxJQUFJLENBQUMsMEJBQTBCLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTt3QkFDekQsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUM7cUJBQ3BELENBQUMsQ0FBQztvQkFFSCx1Q0FBdUM7b0JBQ3ZDLFFBQVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUMsdUNBQXVDO29CQUN2QyxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBRXpDLE9BQU8sb0JBQW9CLENBQUM7aUJBQzdCO3dCQUFTO29CQUNSLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7aUJBQ3JCOztTQUNGO1FBRWEsc0JBQXNCLENBQ2xDLFVBQWtCLEVBQ2xCLFFBQWdCOztnQkFFaEIsZ0NBQWdDO2dCQUNoQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUMvRSxNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBRWxELE9BQU8sQ0FBQSxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQztvQkFDckMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUI7b0JBQ2pDLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFDaEIsQ0FBQztTQUFBO1FBRWEsZUFBZSxDQUMzQixVQUFrQixFQUNsQixRQUFnQixFQUNoQixZQUFZLEdBQUcsWUFBWTs7Z0JBRTNCLE1BQU0sS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFFcEQsTUFBTSxtQkFBbUIsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLHNCQUFzQjtnQkFDN0UsSUFBSSxtQkFBbUIsRUFBRTtvQkFDdkIsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO2lCQUN0RTtnQkFFRCxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtvQkFDeEIsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM5QyxJQUFJLE9BQU8sRUFBRTt3QkFDWCxPQUFPLE9BQU8sQ0FBQztxQkFDaEI7aUJBQ0Y7Z0JBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQ0FBcUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDM0UsQ0FBQztTQUFBO1FBRWEsVUFBVSxDQUFDLFFBQWdCOztnQkFDdkMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3RELElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRTtvQkFDNUIsSUFBSTt3QkFDRixNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUN0RCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7d0JBRXpDLE9BQU8sSUFBSSxDQUFDO3FCQUNiO29CQUFDLFdBQU07d0JBQ04sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO3dCQUUxQyxPQUFPLEtBQUssQ0FBQztxQkFDZDtpQkFDRjtnQkFFRCxPQUFPLFVBQVUsQ0FBQztZQUNwQixDQUFDO1NBQUE7UUFFYSxZQUFZLENBQUMsUUFBZ0I7O2dCQUN6QyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUNwQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUN6QztnQkFFRCxJQUFJLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDbkMsTUFBTSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7b0JBQzlELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztvQkFFMUMsT0FBTyxPQUFPLENBQUM7aUJBQ2hCO2dCQUVELE9BQU8sU0FBUyxDQUFDO1lBQ25CLENBQUM7U0FBQTtLQUNGO0lBakxELHdCQWlMQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge1xuICDJtU5HUmVuZGVyTW9kZSBhcyBOR1JlbmRlck1vZGUsXG4gIMm1TkdSZW5kZXJNb2RlQVBJIGFzIE5HUmVuZGVyTW9kZUFQSSxcbn0gZnJvbSAnQG5ndW5pdmVyc2FsL2NvbW1vbi9jbG92ZXInO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgSlNET00gfSBmcm9tICdqc2RvbSc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVVJMIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IEN1c3RvbVJlc291cmNlTG9hZGVyIH0gZnJvbSAnLi9jdXN0b20tcmVzb3VyY2UtbG9hZGVyJztcbmltcG9ydCB7IElubGluZUNyaXRpY2FsQ3NzUHJvY2Vzc29yIH0gZnJvbSAnLi9pbmxpbmUtY3NzLXByb2Nlc3Nvcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVuZGVyT3B0aW9ucyB7XG4gIGhlYWRlcnM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQgfCBzdHJpbmdbXT47XG4gIHVybDogc3RyaW5nO1xuICBpbmxpbmVDcml0aWNhbENzcz86IGJvb2xlYW47XG4gIGh0bWxGaWxlbmFtZT86IHN0cmluZztcbiAgcHVibGljUGF0aDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgRW5naW5lIHtcbiAgcHJpdmF0ZSByZWFkb25seSBmaWxlRXhpc3RzQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgYm9vbGVhbj4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBodG1sRmlsZUNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSByZXNvdXJjZUxvYWRlckNhY2hlID0gbmV3IE1hcDxzdHJpbmcsIEJ1ZmZlcj4oKTtcbiAgcHJpdmF0ZSByZWFkb25seSBpbmxpbmVDcml0aWNhbENzc1Byb2Nlc3NvciA9IG5ldyBJbmxpbmVDcml0aWNhbENzc1Byb2Nlc3NvcihcbiAgICB7IG1pbmlmeTogdHJ1ZSB9LFxuICAgIHRoaXMucmVzb3VyY2VMb2FkZXJDYWNoZSxcbiAgKTtcblxuICBhc3luYyByZW5kZXIob3B0aW9uczogUmVuZGVyT3B0aW9ucyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgeyBwYXRobmFtZSwgb3JpZ2luIH0gPSBuZXcgVVJMKG9wdGlvbnMudXJsKTtcbiAgICBjb25zdCBwcmVyZW5kZXJlZFNuYXBzaG90ID0gYXdhaXQgdGhpcy5nZXRQcmVyZW5kZXJlZFNuYXBzaG90KG9wdGlvbnMucHVibGljUGF0aCwgcGF0aG5hbWUpO1xuXG4gICAgaWYgKHByZXJlbmRlcmVkU25hcHNob3QpIHtcbiAgICAgIHJldHVybiBwcmVyZW5kZXJlZFNuYXBzaG90O1xuICAgIH1cblxuICAgIGxldCBodG1sQ29udGVudCA9IGF3YWl0IHRoaXMuZ2V0SHRtbFRlbXBsYXRlKFxuICAgICAgb3B0aW9ucy5wdWJsaWNQYXRoLFxuICAgICAgcGF0aG5hbWUsXG4gICAgICBvcHRpb25zLmh0bWxGaWxlbmFtZSxcbiAgICApO1xuICAgIGNvbnN0IGlubGluZUNyaXRpY2FsQ3NzID0gb3B0aW9ucy5pbmxpbmVDcml0aWNhbENzcyAhPT0gZmFsc2U7XG5cbiAgICBjb25zdCBjdXN0b21SZXNvdXJjZUxvYWRlciA9IG5ldyBDdXN0b21SZXNvdXJjZUxvYWRlcihcbiAgICAgIG9yaWdpbixcbiAgICAgIG9wdGlvbnMucHVibGljUGF0aCxcbiAgICAgIHRoaXMucmVzb3VyY2VMb2FkZXJDYWNoZSxcbiAgICApO1xuXG4gICAgbGV0IGRvbTogSlNET00gfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoaW5saW5lQ3JpdGljYWxDc3MpIHtcbiAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29nbGVDaHJvbWVMYWJzL2NyaXR0ZXJzL2lzc3Vlcy82NFxuICAgICAgaHRtbENvbnRlbnQgPSBodG1sQ29udGVudC5yZXBsYWNlKFxuICAgICAgICAvIG1lZGlhPVxcXCJwcmludFxcXCIgb25sb2FkPVxcXCJ0aGlzXFwubWVkaWE9J2FsbCdcIj48bm9zY3JpcHQ+PGxpbmsgLis/PjxcXC9ub3NjcmlwdD4vZyxcbiAgICAgICAgJz4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgZG9tID0gbmV3IEpTRE9NKGh0bWxDb250ZW50LCB7XG4gICAgICAgIHJ1blNjcmlwdHM6ICdkYW5nZXJvdXNseScsXG4gICAgICAgIHJlc291cmNlczogY3VzdG9tUmVzb3VyY2VMb2FkZXIsXG4gICAgICAgIHVybDogb3B0aW9ucy51cmwsXG4gICAgICAgIHJlZmVycmVyOiBvcHRpb25zLmhlYWRlcnM/LnJlZmVycmVyIGFzIHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgdXNlckFnZW50OiBvcHRpb25zLmhlYWRlcnM/LlsndXNlci1hZ2VudCddIGFzIHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgYmVmb3JlUGFyc2U6ICh3aW5kb3cpID0+IHtcbiAgICAgICAgICB3aW5kb3cubmdSZW5kZXJNb2RlID0gdHJ1ZTtcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBkb2MgPSBkb20ud2luZG93LmRvY3VtZW50O1xuXG4gICAgICAvLyA2MHMgdGltZW91dC5cbiAgICAgIGNvbnN0IHN0YWJsaXphdGlvblRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBbmd1bGFyIGFwcGxpY2F0aW9uIGZhaWxlZCB0byBzdGFibGl6ZSBhZnRlciBpbiB0aW1lLicpO1xuICAgICAgfSwgNjAwMDApO1xuXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLXNoYWRvd2VkLXZhcmlhYmxlXG4gICAgICBjb25zdCBuZ1JlbmRlck1vZGUgPSBhd2FpdCBuZXcgUHJvbWlzZTxOR1JlbmRlck1vZGVBUEk+KChyZXNvbHZlKSA9PiB7XG4gICAgICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IG5nRE9NTW9kZSA9IGRvbT8ud2luZG93Lm5nUmVuZGVyTW9kZSBhcyBOR1JlbmRlck1vZGU7XG4gICAgICAgICAgaWYgKG5nRE9NTW9kZSAmJiB0eXBlb2YgbmdET01Nb2RlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgLy8gUG9sbCB1bnRpbCBuZ0RPTU1vZGUgaXMgYW4gb2JqZWN0LlxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHN0YWJsaXphdGlvblRpbWVvdXQpO1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgICAgICByZXNvbHZlKG5nRE9NTW9kZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LCAzMCk7XG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgbmdSZW5kZXJNb2RlLmdldFdoZW5TdGFibGUoKTtcbiAgICAgIGRvYy5xdWVyeVNlbGVjdG9yKCdbbmctdmVyc2lvbl0nKT8uc2V0QXR0cmlidXRlKCduZy1jbG92ZXInLCAnJyk7XG5cbiAgICAgIC8vIEFkZCBBbmd1bGFyIHN0YXRlXG4gICAgICBjb25zdCBzdGF0ZSA9IG5nUmVuZGVyTW9kZS5nZXRTZXJpYWxpemVkU3RhdGUoKTtcbiAgICAgIGlmIChzdGF0ZSkge1xuICAgICAgICBjb25zdCBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG4gICAgICAgIHNjcmlwdC5pZCA9IGAke25nUmVuZGVyTW9kZS5hcHBJZH0tc3RhdGVgO1xuICAgICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgICAgc2NyaXB0LnRleHRDb250ZW50ID0gc3RhdGU7XG4gICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBkb20uc2VyaWFsaXplKCk7XG4gICAgICBpZiAoIW9wdGlvbnMuaW5saW5lQ3JpdGljYWxDc3MpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJhc2VIcmVmID0gZG9jLnF1ZXJ5U2VsZWN0b3IoJ2Jhc2VbaHJlZl0nKT8uZ2V0QXR0cmlidXRlKCdocmVmJykgPz8gJyc7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGNvbnRlbnQ6IGNvbnRlbnRXaXRoSW5saW5lQ1NTLFxuICAgICAgICB3YXJuaW5ncyxcbiAgICAgICAgZXJyb3JzLFxuICAgICAgfSA9IGF3YWl0IHRoaXMuaW5saW5lQ3JpdGljYWxDc3NQcm9jZXNzb3IucHJvY2Vzcyhjb250ZW50LCB7XG4gICAgICAgIG91dHB1dFBhdGg6IHBhdGguam9pbihvcHRpb25zLnB1YmxpY1BhdGgsIGJhc2VIcmVmKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbnNvbGVcbiAgICAgIHdhcm5pbmdzPy5mb3JFYWNoKChtKSA9PiBjb25zb2xlLndhcm4obSkpO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25zb2xlXG4gICAgICBlcnJvcnM/LmZvckVhY2goKG0pID0+IGNvbnNvbGUuZXJyb3IobSkpO1xuXG4gICAgICByZXR1cm4gY29udGVudFdpdGhJbmxpbmVDU1M7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGRvbT8ud2luZG93LmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRQcmVyZW5kZXJlZFNuYXBzaG90KFxuICAgIHB1YmxpY1BhdGg6IHN0cmluZyxcbiAgICBwYXRobmFtZTogc3RyaW5nLFxuICApOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIC8vIFJlbW92ZSBsZWFkaW5nIGZvcndhcmQgc2xhc2guXG4gICAgY29uc3QgcGFnZVBhdGggPSBwYXRoLnJlc29sdmUocHVibGljUGF0aCwgcGF0aG5hbWUuc3Vic3RyaW5nKDEpLCAnaW5kZXguaHRtbCcpO1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnJlYWRIVE1MRmlsZShwYWdlUGF0aCk7XG5cbiAgICByZXR1cm4gY29udGVudD8uaW5jbHVkZXMoJ25nLXZlcnNpb249JylcbiAgICAgID8gY29udGVudCAvLyBQYWdlIGlzIHByZS1yZW5kZXJlZFxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEh0bWxUZW1wbGF0ZShcbiAgICBwdWJsaWNQYXRoOiBzdHJpbmcsXG4gICAgcGF0aG5hbWU6IHN0cmluZyxcbiAgICBodG1sRmlsZW5hbWUgPSAnaW5kZXguaHRtbCcsXG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZmlsZXMgPSBbcGF0aC5qb2luKHB1YmxpY1BhdGgsIGh0bWxGaWxlbmFtZSldO1xuXG4gICAgY29uc3QgcG90ZW50aWFsTG9jYWxlUGF0aCA9IHBhdGhuYW1lLnNwbGl0KCcvJywgMilbMV07IC8vIHBvdGVudGlhbCBiYXNlIGhyZWZcbiAgICBpZiAocG90ZW50aWFsTG9jYWxlUGF0aCkge1xuICAgICAgZmlsZXMucHVzaChwYXRoLmpvaW4ocHVibGljUGF0aCwgcG90ZW50aWFsTG9jYWxlUGF0aCwgaHRtbEZpbGVuYW1lKSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5yZWFkSFRNTEZpbGUoZmlsZSk7XG4gICAgICBpZiAoY29udGVudCkge1xuICAgICAgICByZXR1cm4gY29udGVudDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaWxlIEhUTUwgZmlsZS4gTG9va2VkIGluOiAke2ZpbGVzLmpvaW4oJywgJyl9YCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbGVFeGlzdHMoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGZpbGVFeGlzdHMgPSB0aGlzLmZpbGVFeGlzdHNDYWNoZS5nZXQoZmlsZVBhdGgpO1xuICAgIGlmIChmaWxlRXhpc3RzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLnByb21pc2VzLmFjY2VzcyhmaWxlUGF0aCwgZnMuY29uc3RhbnRzLkZfT0spO1xuICAgICAgICB0aGlzLmZpbGVFeGlzdHNDYWNoZS5zZXQoZmlsZVBhdGgsIHRydWUpO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCB7XG4gICAgICAgIHRoaXMuZmlsZUV4aXN0c0NhY2hlLnNldChmaWxlUGF0aCwgZmFsc2UpO1xuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmlsZUV4aXN0cztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVhZEhUTUxGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICAgIGlmICh0aGlzLmh0bWxGaWxlQ2FjaGUuaGFzKGZpbGVQYXRoKSkge1xuICAgICAgcmV0dXJuIHRoaXMuaHRtbEZpbGVDYWNoZS5nZXQoZmlsZVBhdGgpO1xuICAgIH1cblxuICAgIGlmIChhd2FpdCB0aGlzLmZpbGVFeGlzdHMoZmlsZVBhdGgpKSB7XG4gICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZmlsZVBhdGgsICd1dGYtOCcpO1xuICAgICAgdGhpcy5odG1sRmlsZUNhY2hlLnNldChmaWxlUGF0aCwgY29udGVudCk7XG5cbiAgICAgIHJldHVybiBjb250ZW50O1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==